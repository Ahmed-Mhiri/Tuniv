<div class="chat-container">
  @if (isLoading()) {
    <div class="loading-overlay">
      <nz-spin nzSimple nzSize="large"></nz-spin>
    </div>
  }

  <div class="message-container" #messageContainer>
    @for (msg of messages(); track msg.messageId) {
      <div class="message-wrapper" [class.is-mine]="msg.senderUsername === currentUser()?.username">

        <div class="message-bubble">
          <div class="sender-name">{{ msg.senderUsername }}</div>

          @if (msg.isDeleted) {
            <p class="message-content deleted-message">
              <i>This message was deleted.</i>
            </p>
          } @else {
            @if (msg.content) {
              <p class="message-content" [innerHTML]="sanitizer.bypassSecurityTrustHtml(msg.content)"></p>
            }

            @if (msg.attachments && msg.attachments.length > 0) {
              <div class="attachments">
                @for (att of msg.attachments; track $index) {
                  <a class="attachment-item" [href]="att.fileUrl" target="_blank" [title]="att.fileName">
                    @if (att.fileType.startsWith('image/')) {
                      <img [src]="att.fileUrl" alt="{{ att.fileName }}" class="img-preview" />
                    } @else {
                      <span nz-icon nzType="file-text" class="file-icon"></span>
                      <span class="file-name">{{ att.fileName }}</span>
                    }
                  </a>
                }
              </div>
            }
          }

          @if (msg.reactions && msg.reactions.length > 0) {
            <div class="reactions-container">
              @for (reaction of msg.reactions; track reaction.emoji) {
                <button
                  nz-button
                  nz-tooltip
                  [nzTooltipTitle]="reaction.users.join(', ')"
                  [class.reacted-by-me]="reaction.reactedByCurrentUser"
                  (click)="toggleReaction(msg, reaction.emoji)"
                >
                  {{ reaction.emoji }} {{ reaction.count }}
                </button>
              }
            </div>
          }

          <div class="timestamp">
            @if (msg.status === 'sending') {
              <span nz-icon nzType="clock-circle-o" class="sending-indicator" nz-tooltip="Sending..."></span>
            } @else if (msg.status === 'error') {
              <span nz-icon nzType="exclamation-circle" class="error-indicator" nz-tooltip="Failed to send"></span>
            }
            {{ msg.sentAt | timeAgo }}
          </div>
        </div>
        @if (!msg.isDeleted && msg.messageId > 0) {
          <div class="message-actions">
            <button
              nz-button nzType="text" nzShape="circle"
              nz-popover
              [nzPopoverContent]="emojiPicker"
              nzPopoverTrigger="click"
              nzPopoverPlacement="top"
              aria-label="Add reaction"
              (click)="setActiveMessage(msg)"
            >
              <span nz-icon nzType="smile" nzTheme="outline"></span>
            </button>

            <button
              nz-button nzType="text" nzShape="circle"
              nz-dropdown [nzDropdownMenu]="menu"
              aria-label="More options"
            >
              <span nz-icon nzType="ellipsis" nzTheme="outline"></span>
            </button>
            <nz-dropdown-menu #menu="nzDropdownMenu">
              <ul nz-menu>
                @if (msg.senderUsername === currentUser()?.username) {
                  <li nz-menu-item (click)="deleteMessage(msg.messageId)">Delete</li>
                }
                @if (msg.content) {
                  <li nz-menu-item (click)="openForwardModal(msg)">Forward</li>
                }
              </ul>
            </nz-dropdown-menu>
          </div>
        }
      </div>
    }
  </div>

  <div class="message-input-area">
    @if (fileList().length > 0) {
      <div class="file-preview-list">
        @for (file of fileList(); track file.uid) {
          <div class="file-item">
            <span nz-icon nzType="file-text"></span>
            <span>{{ file.name }}</span>
            <button nz-button nzType="text" nzShape="circle" (click)="removeFile(file)">
              <span nz-icon nzType="close"></span>
            </button>
          </div>
        }
      </div>
    }

    <form class="input-form" [formGroup]="messageForm" (ngSubmit)="sendMessage()">
      <nz-upload [nzFileList]="fileList()" [nzBeforeUpload]="beforeUpload" [nzShowUploadList]="false">
        <button nz-button nzType="text" nzShape="circle" type="button" class="attach-btn" nz-tooltip="Attach files">
          <span nz-icon nzType="paper-clip"></span>
        </button>
      </nz-upload>
      <textarea
        nz-input
        formControlName="content"
        placeholder="Type a message..."
        [nzAutosize]="{ minRows: 1, maxRows: 4 }"
        (keydown.enter)="handleEnterPress($any($event))"
      ></textarea>
      <button nz-button nzType="primary" nzShape="circle" type="submit" class="send-btn" [disabled]="isSending() || messageForm.invalid">
        <span nz-icon nzType="send"></span>
      </button>
    </form>
  </div>
</div>

<ng-template #emojiPicker>
  <div class="emoji-picker" (click)="$event.stopPropagation()">
    @for (emoji of availableReactions; track emoji) {
      <button
        nz-button
        nzType="text"
        class="emoji-button"
        (click)="handleEmojiClick(emoji, $event)"
      >
        {{ emoji }}
      </button>
    }
  </div>
</ng-template>