
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    profile_photo_url VARCHAR(255),
    bio TEXT,
    major VARCHAR(255),
    reputation_score INT NOT NULL DEFAULT 0,
    reset_password_token VARCHAR(255),
    reset_password_token_expiry TIMESTAMP WITH TIME ZONE,
    is_2fa_enabled BOOLEAN NOT NULL DEFAULT false,
    two_factor_auth_secret VARCHAR(255),
    verification_token VARCHAR(255),
    is_enabled BOOLEAN NOT NULL DEFAULT false
);

CREATE TABLE universities (
    university_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE
);

CREATE TABLE conversations (
    conversation_id SERIAL PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Tables with Dependencies
CREATE TABLE modules (
    module_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    university_id INT NOT NULL,
    CONSTRAINT fk_module_university FOREIGN KEY (university_id) REFERENCES universities(university_id) ON DELETE CASCADE
);

CREATE TABLE university_memberships (
    user_id INT NOT NULL,
    university_id INT NOT NULL,
    role VARCHAR(255) NOT NULL,
    PRIMARY KEY (user_id, university_id),
    CONSTRAINT fk_membership_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_membership_university FOREIGN KEY (university_id) REFERENCES universities(university_id) ON DELETE CASCADE
);

CREATE TABLE conversation_participants (
    user_id INT NOT NULL,
    conversation_id INT NOT NULL,
    last_read_timestamp TIMESTAMP WITH TIME ZONE,
    PRIMARY KEY (user_id, conversation_id),
    CONSTRAINT fk_participant_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_participant_conversation FOREIGN KEY (conversation_id) REFERENCES conversations(conversation_id) ON DELETE CASCADE
);

CREATE TABLE notifications (
    notification_id SERIAL PRIMARY KEY,
    recipient_id INT NOT NULL,
    actor_id INT,
    type VARCHAR(50) NOT NULL,
    message VARCHAR(255) NOT NULL,
    link VARCHAR(512) NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT fk_notification_recipient FOREIGN KEY (recipient_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_notification_actor FOREIGN KEY (actor_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Unified Posts Table
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    post_type VARCHAR(31) NOT NULL,
    user_id INT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    body TEXT,
    title VARCHAR(255),
    module_id INT,
    is_solution BOOLEAN,
    question_id INT,
    answer_id INT,
    parent_comment_id INT,
    conversation_id INT,
    sent_at TIMESTAMP WITH TIME ZONE,
    is_deleted BOOLEAN NOT NULL DEFAULT false, -- ✅ ADDED: For soft-deleting messages
    CONSTRAINT fk_post_author FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_post_module FOREIGN KEY (module_id) REFERENCES modules(module_id),
    CONSTRAINT fk_post_question FOREIGN KEY (question_id) REFERENCES posts(id) ON DELETE CASCADE,
    CONSTRAINT fk_post_answer FOREIGN KEY (answer_id) REFERENCES posts(id) ON DELETE CASCADE,
    CONSTRAINT fk_post_parent_comment FOREIGN KEY (parent_comment_id) REFERENCES posts(id) ON DELETE CASCADE,
    CONSTRAINT fk_post_conversation FOREIGN KEY (conversation_id) REFERENCES conversations(conversation_id) ON DELETE CASCADE
);

-- Votes, Attachments & Reactions (Depend on 'posts' and 'users' tables)
CREATE TABLE question_votes (
    user_id INT NOT NULL,
    question_id INT NOT NULL,
    "value" SMALLINT NOT NULL CHECK ("value" IN (-1, 1)),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, question_id),
    CONSTRAINT fk_qvote_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_qvote_question FOREIGN KEY (question_id) REFERENCES posts(id) ON DELETE CASCADE
);

CREATE TABLE answer_votes (
    user_id INT NOT NULL,
    answer_id INT NOT NULL,
    "value" SMALLINT NOT NULL CHECK ("value" IN (-1, 1)),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, answer_id),
    CONSTRAINT fk_avote_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_avote_answer FOREIGN KEY (answer_id) REFERENCES posts(id) ON DELETE CASCADE
);

CREATE TABLE comment_votes (
    user_id INT NOT NULL,
    comment_id INT NOT NULL,
    "value" SMALLINT NOT NULL CHECK ("value" IN (-1, 1)),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, comment_id),
    CONSTRAINT fk_cvote_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_cvote_comment FOREIGN KEY (comment_id) REFERENCES posts(id) ON DELETE CASCADE
);

CREATE TABLE attachments (
    attachment_id SERIAL PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    file_url VARCHAR(1024) NOT NULL,
    file_type VARCHAR(100),
    file_size BIGINT,
    uploaded_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    post_id INT NOT NULL,
    CONSTRAINT fk_attachment_post FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
);

-- ✅ ADDED: New table for message reactions
CREATE TABLE message_reactions (
    message_id INT NOT NULL,
    user_id INT NOT NULL,
    emoji VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (message_id, user_id, emoji), -- Composite key to allow one user to add multiple different emojis
    CONSTRAINT fk_reaction_message FOREIGN KEY (message_id) REFERENCES posts(id) ON DELETE CASCADE,
    CONSTRAINT fk_reaction_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);


-- Indexes
CREATE INDEX idx_notifications_recipient_id ON notifications(recipient_id);
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_module_id ON posts(module_id);
CREATE INDEX idx_posts_question_id ON posts(question_id);
CREATE INDEX idx_posts_answer_id ON posts(answer_id);
CREATE INDEX idx_posts_post_type ON posts(post_type);
CREATE INDEX idx_attachments_post_id ON attachments(post_id);



(681, 6, 'Biochimie', 1, 'Médecine Dentaire'),
(682, 6, 'Anatomie générale', '1-2', 'Médecine Dentaire'),
(683, 6, 'Anatomie dentaire', 2, 'Médecine Dentaire'),
(684, 6, 'Physiologie générale', 2, 'Médecine Dentaire'),
(685, 6, 'Physique et Biophysique', 1, 'Médecine Dentaire'),
(686, 6, 'Chimie organique, générale et minérale', '1-2', 'Médecine Dentaire'),
(687, 6, 'Génétique, Cytologie, Biologie cellulaire et moléculaire', '1-2', 'Médecine Dentaire'),
(688, 6, 'Histologie et Embryologie', '1-2', 'Médecine Dentaire'),
(689, 6, 'Biostatistiques, Informatique, Prévention et économie de la santé', 1, 'Médecine Dentaire'),
(690, 6, 'Histoire et philosophie des sciences', 1, 'Médecine Dentaire'),
(691, 6, 'Anglais', '1-2', 'Médecine Dentaire'),
(692, 6, 'Biophysique', 3, 'Médecine Dentaire'),
(693, 6, 'Biochimie', 3, 'Médecine Dentaire'),
(694, 6, 'Anatomie cervico-faciale', 3, 'Médecine Dentaire'),
(695, 6, 'Biomatériaux', 4, 'Médecine Dentaire'),
(696, 6, 'Odontologie conservatrice', '3-4', 'Médecine Dentaire'),
(697, 6, 'Prothèse conjointe', 4, 'Médecine Dentaire'),
(698, 6, 'Prothèse Partielle Amovible', '3-4', 'Médecine Dentaire'),
(699, 6, 'Histologie et Embryologie bucco-dentaire', 3, 'Médecine Dentaire'),
(700, 6, 'Physiologie Générale et Oro-Faciale', '3-4', 'Médecine Dentaire'),
(701, 6, 'Hématologie et Oncologie', 3, 'Médecine Dentaire'),
(702, 6, 'Techniques premiers secours & oxiologie', 4, 'Médecine Dentaire'),
(703, 6, 'Bioéthique et Psychologie', 4, 'Médecine Dentaire'),
(704, 6, 'Anglais', '3-4', 'Médecine Dentaire'),
(705, 6, 'Sémiologie Clinique & Pathologie Médicale', '5-6', 'Médecine Dentaire'),
(706, 6, 'Anatomie Pathologique', 6, 'Médecine Dentaire'),
(707, 6, 'Hygiène et Prévention', 6, 'Médecine Dentaire'),
(708, 6, 'Pharmacologie', 6, 'Médecine Dentaire'),
(709, 6, 'Anesthésiologie', 5, 'Médecine Dentaire'),
(710, 6, 'Physiologie Bucco-Dentaire & Anatomie Fonctionnelle', 6, 'Médecine Dentaire'),
(711, 6, 'Bactériologie & Virologie', '5-6', 'Médecine Dentaire'),
(712, 6, 'Immunologie', 5, 'Médecine Dentaire'),
(713, 6, 'Biomatériaux', 5, 'Médecine Dentaire'),
(714, 6, 'Odontologie Conservatrice', '5-6', 'Médecine Dentaire'),
(715, 6, 'Prothèse Partielle Amovible', 6, 'Médecine Dentaire'),
(716, 6, 'Prothèse Conjointe', '5-6', 'Médecine Dentaire'),
(717, 6, 'Prothèse Totale', '5-6', 'Médecine Dentaire'),
(718, 6, 'Médecine & Chirurgie Buccales', 5, 'Médecine Dentaire'),
(719, 6, 'Parodontologie', 5, 'Médecine Dentaire'),
(720, 6, 'O.D.F. & Croissance et Développement', 5, 'Médecine Dentaire'),
(721, 6, 'Anglais', '5-6', 'Médecine Dentaire'),
(722, 6, 'Odontologie Conservatrice', '7-8', 'Médecine Dentaire'),
(723, 6, 'Prothèse Conjointe', '7-8', 'Médecine Dentaire'),
(724, 6, 'Prothèse Partielle Amovible', '7-8', 'Médecine Dentaire'),
(725, 6, 'Prothèse Totale', '7-8', 'Médecine Dentaire'),
(726, 6, 'Parodontologie', '7-8', 'Médecine Dentaire'),
(727, 6, 'Médecine et Chirurgie buccales', '7-8', 'Médecine Dentaire'),
(728, 6, 'Pédodontie-Prévention', '7-8', 'Médecine Dentaire'),
(729, 6, 'Orthopédie Dento-Faciale', '7-8', 'Médecine Dentaire'),
(730, 6, 'Imagerie Médicale', 7, 'Médecine Dentaire'),
(731, 6, 'Anatomie Pathologique', 7, 'Médecine Dentaire'),
(732, 6, 'Sémiologie Clinique & Pathologie Chirurgicale', '7-8', 'Médecine Dentaire'),
(733, 6, 'Psychologie', 7, 'Médecine Dentaire'),
(734, 6, 'Gérodontologie', 7, 'Médecine Dentaire'),
(735, 6, 'Occlusodontie', 7, 'Médecine Dentaire'),
(736, 6, 'Anglais', '7-8', 'Médecine Dentaire'),
(737, 6, 'Odontologie Conservatrice', '9-10', 'Médecine Dentaire'),
(738, 6, 'Prothèse Conjointe', '9-10', 'Médecine Dentaire'),
(739, 6, 'Prothèse Partielle Amovible', '9-10', 'Médecine Dentaire'),
(740, 6, 'Parodontologie', '9-10', 'Médecine Dentaire'),
(741, 6, 'Médecine et Chirurgie buccales', '9-10', 'Médecine Dentaire'),
(742, 6, 'Pédodontie-Prévention', '9-10', 'Médecine Dentaire'),
(743, 6, 'Orthopédie Dento-Faciale', '9-10', 'Médecine Dentaire'),
(744, 6, 'Droit et Déontologie, Odontologie Légale, Ergonomie, Droits de l''Homme et Droit humanitaire', '9-10', 'Médecine Dentaire'),
(745, 6, 'Implantologie et Prothèse Maxillo-Faciale', '9-10', 'Médecine Dentaire'),
(746, 6, 'Anglais', '9-10', 'Médecine Dentaire'),
(747, 6, 'Stage en Prothèse Totale', '9-10', 'Médecine Dentaire'),
(748, 6, 'Stage interné', '11-12', 'Médecine Dentaire'),